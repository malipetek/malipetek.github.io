import { _ as _export_sfc, o as openBlock, c as createElementBlock, a as createStaticVNode } from "./app.58ffe7f5.js";
const _imports_0 = "/assets/link-comparison.ccacb9e3.jpg";
const _imports_1 = "/assets/debugger.3303e976.jpg";
const _imports_2 = "/assets/attributes.69d6d160.jpg";
const _imports_3 = "/assets/gpt_exp.a3060a6b.jpg";
const __pageData = JSON.parse('{"title":"Why my image is not hydrating correctly when Svelte initializes","description":"","frontmatter":{},"headers":[{"level":2,"title":"Preface","slug":"preface","link":"#preface","children":[]},{"level":2,"title":"The Problem","slug":"the-problem","link":"#the-problem","children":[]},{"level":2,"title":"Conclusion","slug":"conclusion","link":"#conclusion","children":[]},{"level":2,"title":"Outro","slug":"outro","link":"#outro","children":[{"level":3,"title":"Related Topics","slug":"related-topics","link":"#related-topics","children":[]}]}],"relativePath":"blog/svelte/why-my-image-is-not-hydrating-right.md"}');
const _sfc_main = { name: "blog/svelte/why-my-image-is-not-hydrating-right.md" };
const _hoisted_1 = /* @__PURE__ */ createStaticVNode('<h1 id="why-my-image-is-not-hydrating-correctly-when-svelte-initializes" tabindex="-1">Why my image is not hydrating correctly when Svelte initializes <a class="header-anchor" href="#why-my-image-is-not-hydrating-correctly-when-svelte-initializes" aria-hidden="true">#</a></h1><h2 id="preface" tabindex="-1">Preface <a class="header-anchor" href="#preface" aria-hidden="true">#</a></h2><p>I am writing a Shopify theme using <a href="https://liquivelte.js.org">liquivelte</a> which is in essence liquid rendered html being hydrated with svelte.</p><p>I have added support for the <a href="https://shopify.dev/docs/api/liquid/filters/image_tag">image_tag filter</a> which outputs a <code>img</code> tag so it is not a input output case for svelte side. Normally how I handle liquid filter conterpart on svelte side is like this. Let&#39;s say there is a image_url filter</p><div class="language-liquivelte"><button title="Copy Code" class="copy"></button><span class="lang">liquivelte</span><pre class="shiki github-dark" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">img</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">src</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;{{-</span><span style="color:#9ECBFF;"> </span><span style="color:#E1E4E8;">somevalue</span><span style="color:#9ECBFF;"> </span><span style="color:#F97583;">|</span><span style="color:#9ECBFF;"> </span><span style="color:#B392F0;">image_url</span><span style="color:#9ECBFF;">: </span><span style="color:#B392F0;">width</span><span style="color:#9ECBFF;">: </span><span style="color:#79B8FF;">300</span><span style="color:#9ECBFF;"> </span><span style="color:#9ECBFF;">-}}&quot;</span><span style="color:#E1E4E8;"> &gt;</span></span>\n<span class="line"></span></code></pre></div><p>liquivelte converts it to</p><div class="language-svelte"><button title="Copy Code" class="copy"></button><span class="lang">svelte</span><pre class="shiki github-dark" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">img</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">src</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;{</span><span style="color:#9ECBFF;"> </span><span style="color:#E1E4E8;">liquid</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">image_url</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">somevalue</span><span style="color:#9ECBFF;">, {width: </span><span style="color:#79B8FF;">300</span><span style="color:#9ECBFF;">}) </span><span style="color:#9ECBFF;">}&quot;</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"></span></code></pre></div><p>This is fine for input output case scenarios. However <code>image_tag</code> is different. One might say this is a more complex filter. Then I moved forward with adding an exception for <code>image_tag</code> and it became like this. Lets say we have a image tag expression:</p><div class="language-liquivelte"><button title="Copy Code" class="copy"></button><span class="lang">liquivelte</span><pre class="shiki github-dark" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">class</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;image-container&quot;</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  {{- product.images[0] | image_url: width: 300 | image_tag }}</span></span>\n<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"></span></code></pre></div><p>It would output</p><div class="language-svelte"><button title="Copy Code" class="copy"></button><span class="lang">svelte</span><pre class="shiki github-dark" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">class</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;image-container&quot;</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  &lt;</span><span style="color:#85E89D;">img</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">{</span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">liquid.</span><span style="color:#B392F0;">image_tag</span><span style="color:#E1E4E8;">( liquid.</span><span style="color:#B392F0;">image_url</span><span style="color:#E1E4E8;">(product.images[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], {width: </span><span style="color:#79B8FF;">300</span><span style="color:#E1E4E8;">}), {} ) </span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> /&gt;</span></span>\n<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"></span></code></pre></div><p>I thought why not, lets add <code>image_tag</code> filter as a utility function and spread props that come out of it. I did not see what was coming.</p><h2 id="the-problem" tabindex="-1">The Problem <a class="header-anchor" href="#the-problem" aria-hidden="true">#</a></h2><p>I realized images are loading correctly, however there was a flashing. Images would reload. This is a no no, this means large layout shifts, this means bad UX. But what was wrong, I checked network panel for single image and it was loading exactly same image 2 times. Here is I am comparing 2 urls thinking it got to be different. <img src="' + _imports_0 + '" alt="image url comparison"></p><p>I went to svelte issues and spent some time on this <a href="https://github.com/sveltejs/svelte/issues/4308">better hydration issue</a> but I was thinking &quot;this is about iframes and stuff, images are so essential for web it would be much more fuss it this was happening on images all the time&quot;. Then I went back to trustworthy devtools to find my way around. Started debugging and added a <code>debugger;</code> statement at the end of image statement as an inline script. That would stop html parsing at that point so I know at that point initial image is there. At this point I went to &quot;elements&quot; panel and added (DOM breakpoints)[<a href="https://developer.chrome.com/docs/devtools/javascript/breakpoints/#dom">https://developer.chrome.com/docs/devtools/javascript/breakpoints/#dom</a>] to the element itself to find out which function is replacing or modifying the element. <img src="' + _imports_1 + '" alt="ss of adding dom breakpoints"></p><p>Indeed I found the function who replaces the node and adds a new one. It is a core svelte function called <code>claim_element_base</code>. <img src="' + _imports_2 + '" alt="function with name claim_element_base"></p><p>This function is checking if existing element has attributes of the svelte counterpart of that element. If it does not have an attribute it mark it for removal.</p><p>This is what gpt has to say about it: <img src="' + _imports_3 + '" alt="gpts word on the function"></p><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-hidden="true">#</a></h2><p>At the end of the day answer to question of this article is; if you use props spreading in svelte, your elements will get destroyed and re-created when hydrating. I now converted the conversion logic to use attributes one by one and it works like a charm.</p><p>When there is a expression in liquid side with image tag I convert it to</p><div class="language-svelte"><button title="Copy Code" class="copy"></button><span class="lang">svelte</span><pre class="shiki github-dark" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  &lt;</span><span style="color:#85E89D;">img</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">src</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;{</span><span style="color:#E1E4E8;">liquid</span><span style="color:#9ECBFF;">.</span><span style="color:#B392F0;">image_url</span><span style="color:#9ECBFF;">(</span><span style="color:#E1E4E8;">product</span><span style="color:#9ECBFF;">.</span><span style="color:#E1E4E8;">images</span><span style="color:#9ECBFF;">[</span><span style="color:#79B8FF;">0</span><span style="color:#9ECBFF;">], {width: </span><span style="color:#79B8FF;">300</span><span style="color:#9ECBFF;">}), {} ) </span><span style="color:#9ECBFF;">}&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">srcset</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">...</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">alt</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">...</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> /&gt;</span></span>\n<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"></span></code></pre></div><p>instead of prop spreading like this:</p><div class="language-svelte"><button title="Copy Code" class="copy"></button><span class="lang">svelte</span><pre class="shiki github-dark" tabindex="0"><code><span class="line"><span style="color:#E1E4E8;">&lt;</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">class</span><span style="color:#E1E4E8;">=</span><span style="color:#9ECBFF;">&quot;image-container&quot;</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"><span style="color:#E1E4E8;">  &lt;</span><span style="color:#85E89D;">img</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">{</span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;">liquid.</span><span style="color:#B392F0;">image_tag</span><span style="color:#E1E4E8;">( liquid.</span><span style="color:#B392F0;">image_url</span><span style="color:#E1E4E8;">(product.images[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], {width: </span><span style="color:#79B8FF;">300</span><span style="color:#E1E4E8;">}), {} ) </span><span style="color:#B392F0;">}</span><span style="color:#E1E4E8;"> /&gt;</span></span>\n<span class="line"><span style="color:#E1E4E8;">&lt;/</span><span style="color:#85E89D;">div</span><span style="color:#E1E4E8;">&gt;</span></span>\n<span class="line"></span></code></pre></div><h2 id="outro" tabindex="-1">Outro <a class="header-anchor" href="#outro" aria-hidden="true">#</a></h2><p>I am not someone with obsession to address layout shift issues. Layout shifts are unacceptable in todays more and more competitive web development industry. They are the one of best known UX spoilers and we should eliminate them at whichever cost I believe.</p><p>Doing so it more and more easy nowadays. With the death of IE and browser vendors adopting improvements faster than ever, you should at least ship code with <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/aspect-ratio"><code>aspect-ratio</code> css property</a> to ensure thing do not jump around when page is loading or styles are applying consecutively.</p><h3 id="related-topics" tabindex="-1">Related Topics <a class="header-anchor" href="#related-topics" aria-hidden="true">#</a></h3><p>If you care I would suggest learning these concepts for a performance competitive or UX acceptable web page.</p><ul><li><a href="https://web.dev/extract-critical-css/">Critical CSS (above the fold styles)</a></li><li><a href="https://caniuse.com/mdn-css_properties_aspect-ratio">Apect-ratio</a></li><li><a href="https://caniuse.com/object-fit">Object-fit</a></li><li><a href="https://web.dev/native-lazy-loading/">Lazy loading images</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images">Using responsive images (srcset)</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Learn/Performance/How_fast#minification_and_compression_of_assets">Minification and compression of assets</a></li><li><a href="https://developer.chrome.com/blog/modulepreload/">Module preloading</a></li><li><a href="https://web.dev/optimize-third-party-javascript/">Optimizing third-party scripts</a></li><li><a href="https://webpack.js.org/guides/code-splitting/">Code splitting</a></li><li><a href="https://www.smashingmagazine.com/2016/02/preload-what-is-it-good-for/">Preloading in general</a></li><li><a href="https://css-tricks.com/prerender-on-hover/">Prefetching url(when using client side routing)</a></li></ul>', 30);
const _hoisted_31 = [
  _hoisted_1
];
function _sfc_render(_ctx, _cache, $props, $setup, $data, $options) {
  return openBlock(), createElementBlock("div", null, _hoisted_31);
}
const whyMyImageIsNotHydratingRight = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render]]);
export {
  __pageData,
  whyMyImageIsNotHydratingRight as default
};
